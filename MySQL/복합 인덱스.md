## 복합인덱스란?
복합 인덱스는 두개 이상의 컬럼을 조합해서 만든 인덱스,  
단일 컬럼 인덱스와 달리 여러 컬럼의 값을 순서대로 조합해서 하나의 인덱스로 만든다

### 복합 인덱스의 동작 원리
복합 인덱스는 첫번째 컬름을 기준으로 정렬하고 이어서 두번째 컬럼으로 정렬하는 방식

```sql
-- (age, city) 복합 인덱스 예시
CREATE INDEX idx_age_city ON users (age, city);
```

내부 구조는 아래와 같은 방식

```
25, 'Seoul'
25, 'Busan'
26, 'Seoul'
27, 'Incheon'
```

### 왼쪽 우선 원칙
복합 인덱스에는 `왼쪽 우선 원칙`이라는 핵심 규칙이 있다.  
(age, city, name)이라는 복합 인덱스가 있으면

- ✅ WHERE age = 25 (가능)
- ✅ WHERE age = 25 AND city = 'Seoul' (가능)
- ✅ WHERE age = 25 AND city = 'Seoul' AND name = 'Kim' (가능)
- ❌ WHERE city = 'Seoul' (인덱스 효과 없음)
- ❌ WHERE name = 'Kim' (인덱스 효과 없음)  

왜냐하면 인덱스가 age를 기준으로 정렬되어 있으므로 age 조건없이는 효율적인 탐색이 불가능
즉, 첫번쨰 인덱스 조건은 조회 조건에 포함되어야 한다

### 언제 복합 인덱스를 사용해야하나
+ 여러 컬럼을 함께 조회하는 쿼리가 빈번하게 사용될 때
```sql
SELECT * FROM orders 
WHERE customer_id = 123 AND order_date = '2024-01-01';
```

+ 정렬 조건이 여러 컬럼일 때
```sql
SELECT * FROM products 
ORDER BY category, price;
```

+ 범위 검색과 정확한 매칭이 함께 존재할 때
```sql
SELECT * FROM logs 
WHERE user_id = 100 AND created_at BETWEEN '2024-01-01' AND '2024-01-31';
```

### 복합 인덱스의 장단점

+ 장점
    - 여러 컬럼 조건 쿼리의 성능 향상
    - 커버링 인덱스로 활용 가능 (인덱스만으로 모든 데이터 조회)
    - ORDER BY 성능 향상

+ 단점
    - 저장 공간 사용량 증가
    - INSERT/UPDATE/DELETE 시 오버헤드 증가
    - 컬럼 순서가 매우 중요함

### 복합 인덱스와 커버링 인덱스

+ 복합 인덱스 (Composite Index)
    - 컬럼 개수를 기준으로 한 분류
    - 2개 이상의 컬럼으로 만든 인덱스
    - 테이블의 모든 컬럼을 포함할 수도 있고, 일부만 포함할 수도 있음

+ 커버링 인덱스 (Covering Index)
    - 쿼리 실행 방식을 기준으로 한 분류
    - 특정 쿼리에 필요한 모든 컬럼이 인덱스에 포함된 경우
    - 테이블 전체 컬럼이 아니라, 그 쿼리가 필요로 하는 컬럼들만 있으면 됨

```sql
CREATE TABLE users (
    id INT,
    name VARCHAR(50),
    email VARCHAR(100),
    age INT,
    city VARCHAR(50),
    salary INT,
    department VARCHAR(50)
);
```

+ 예시1
복합 인덱스이면서 커버링 인덱스
```sql
CREATE INDEX idx_dept_salary_age ON users (department, salary, age);

-- 이 쿼리에 대해서는 커버링 인덱스로 동작
SELECT department, salary, age 
FROM users 
WHERE department = 'IT' AND salary > 50000;
```

+ 예시2
복합 인덱스이지만 커버링 인덱스가 아님
```sql
CREATE INDEX idx_dept_salary_age ON users (department, salary, age);

-- 이 쿼리에서는 커버링 인덱스가 아님 (name이 인덱스에 없음)
SELECT name, department, salary 
FROM users 
WHERE department = 'IT';
```

+ 예시3
단일 컬럼이지만 커버링 인덱스
```sql
CREATE INDEX idx_department ON users (department);

-- 이 쿼리에 대해서는 커버링 인덱스로 동작
SELECT COUNT(*) 
FROM users 
WHERE department = 'IT';
```