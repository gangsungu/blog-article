## 데드락 회피&방지

### 데드락이란?
둘 이상의 프로세스나 스레드가 서로 상대방이 가진 자원을 기다리면서 무한정 대기하는 상황
MySQL에서는 주로 `트랜잭션 간의 락 경합`떄문에 데드락이 발생한다

```sql
-- 트랜잭션 A
BEGIN;
UPDATE users SET name = 'Alice' WHERE id = 1;  -- users(id=1) 락 획득
UPDATE users SET name = 'Bob' WHERE id = 2;    -- users(id=2) 락 기다림

-- 트랜잭션 B (동시 실행)
BEGIN;
UPDATE users SET name = 'Charlie' WHERE id = 2; -- users(id=2) 락 획득  
UPDATE users SET name = 'David' WHERE id = 1;   -- users(id=1) 락 기다림
-- 💥 데드락 발생!
```

### 데드락의 탐지와 처리
MySQL InnoDB는 자동으로 데드락을 탐지하여 처리한다

+ 데드락을 감지하면 자동으로 하나의 트랜잭션을 롤백
    - 보통 더 적은 행을 수행한 트랜잭션을 롤백대상으로 선택
    - ERROR 1213 (40001): Deadlock found when trying to get lock 에러 발생

### MySQL 데드락 방지 전략
+ 일관된 순서로 테이블/행 접근
    ```sql
    -- 나쁜 예: 서로 다른 순서로 접근
    -- 트랜잭션 A
    UPDATE users SET status = 'active' WHERE id = 100;
    UPDATE orders SET status = 'shipped' WHERE id = 200;

    -- 트랜잭션 B  
    UPDATE orders SET status = 'cancelled' WHERE id = 200;
    UPDATE users SET status = 'inactive' WHERE id = 100;

    -- 좋은 예: 항상 같은 순서로 접근 (예: users 테이블 먼저)
    -- 모든 트랜잭션에서
    UPDATE users SET status = 'active' WHERE id = 100;
    UPDATE orders SET status = 'shipped' WHERE id = 200;
    ```

+ 인덱스를 활용한 범위 최소화
    ```sql
    -- 나쁜 예: 인덱스 없이 스캔하면 많은 락 발생
    UPDATE users SET last_login = NOW() 
    WHERE email = 'user@example.com';  -- email에 인덱스 없음

    -- 좋은 예: 인덱스로 정확한 행만 락
    ALTER TABLE users ADD INDEX idx_email (email);
    UPDATE users SET last_login = NOW() 
    WHERE email = 'user@example.com';  -- 최소한의 락만 발생
    ```

+ 트랜잭션 크기 최소화
    ```sql
    -- 나쁜 예: 큰 트랜잭션
    BEGIN;
    UPDATE users SET status = 'processing' WHERE created_at < '2024-01-01';  -- 수천 개 행 락
    -- ... 복잡한 비즈니스 로직 (시간 오래 걸림)
    UPDATE orders SET status = 'processed' WHERE user_id IN (...);
    COMMIT;

    -- 좋은 예: 작은 단위로 분할
    -- 배치로 처리하거나 필요한 부분만 트랜잭션으로 처리
    ```

+ SELECT FOR UPDATE 신중하게 사용
    ```sql
    -- 위험한 패턴
    BEGIN;
    SELECT balance FROM accounts WHERE id = 1 FOR UPDATE;  -- 락 획득
    SELECT balance FROM accounts WHERE id = 2 FOR UPDATE;  -- 다른 순서로 락 시도

    -- 더 안전한 패턴: 한 번에 정렬된 순서로 락 획득
    BEGIN;
    SELECT balance FROM accounts WHERE id IN (1, 2) ORDER BY id FOR UPDATE;
    ```

### MySQL 데드락 회피 전략
+ 락 타임아웃 설정
    ```sql
    -- 락 대기 시간 설정 (초 단위)
    SET innodb_lock_wait_timeout = 5;  -- 기본값은 50초
    ```