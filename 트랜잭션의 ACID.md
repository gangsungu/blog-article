## 트랜잭션의 ACID 속성?

이전 포스팅에서 배운 트랜잭션은 데이터베이스에서 하나의 **논리적 작업 단위**를 말한다.

### ACID란?

ACID는 트랜잭션이 안전하게 수행되기 위해 보장해야 하는 네가지 속성의 첫글짜를 딴 약어다.

-   원자성(Atomicity)

트랜잭션의 모든 작업이 완전히 수행되거나 모두 수행되지 않아야 한다.

중간에 실패하면 이미 실행된 작업들도 모두 취소되어 초기 상태로 돌아가야 한다.

```
1. 내 계좌에서 10만원 출금 : 성공✅
2. 친구 계좌에 10만원 입금 : 실패🔥
```

실패하면 초기 상태로 돌아가 내 계좌에서 10만원 출금도 취소되어야 한다.

-   일관성(Consistency)

트랜잭션 실행 전후에 데이터베이스의 `무결성 제약조건`이 항상 만족되어야 한다.

```
계좌 잔액은 항상 0원 이상이어야 한다.(제약조건)
이체 후에도 모든 계좌의 잔액은 >= 0을 유지해야 한다
```

-   격리성(Isolation)

동시에 실행되는 트랜잭션들이 서로 영향을 주지 않아야 한다.

```
A와 B가 동시에 상품 C를 1개씩 주문하였을 때, 
재고는 정확히 2개가 차감되어야 한다.
```

-   지속성(Durability)

성공적으로 완료된 트랜잭션의 결과는 영구적으로 보존되어야 한다.  
시스템 장애가 발생하여도 데이터가 유실되면 안된다.

```
주문 완료 후, 시스템 다운
시스템 재시작 후에도 주문 데이터가 남아있어야 한다.
```

### 이해도 확인 문제

문제 1 : 다음 상황에서 어떤 ACID 속성이 위반되었는지 확인해보자.

상황: 온라인 쇼핑몰에서 마지막 재고 1개인 상품을 두 고객이 동시에 주문했는데,  
둘 다 주문이 성공되었습니다.

<details>
  <summary>펼치기</summary>

  아주 쉬운 문제😎, `격리성`이다.
  이런 상황을 `Race Condition`이라고도 부른다.
</details>

문제 2 : 계좌이체 시스템에서 다음과 같은 트랜잭션을 설계한다면 각 단계에서 어떤 ACID 속성을 보장해야 하는가.

1.  A계좌 잔액 확인
2.  A계좌에서 금액 차감
3.  B계좌에 금액 추가
4.  거래 내역 로그 저장

<details>
  <summary>펼치기</summary>

  1. A계좌 잔액 확인
  일관성 : 잔액 >=0 제약조건 확인
  
  2. A계좌에서 금액 차감
  원자성 : 차감 작업이 완전히 성공하거나 실패
  일관성 : 차감 후에도 잔액 >= 0 유지
  
  3. B계좌에 금액 추가
  원자성 : 입금 금액이 완전히 성공하거나 실패
  일관성 : 전체 자금(출금과 입금)의 총합이 동일
  
  4. 거래 내역 로그 저장
  지속성 : 거래 완료 후, 영구 보존
  원자성 : 로그 저장 실패시, 전체 거래를 롤백할지 정해야 함
  
  그리고 모든 단계는 공통적으로 격리성을 보장
  4번의 원자성은 로그 저장에 실패하면 전체적으로 롤백하느냐
  따로 보상 트랜잭션으로 로그 저장을 별도 처리하느냐의 차이다
</details>
